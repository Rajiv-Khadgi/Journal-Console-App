
@inject SecurityService SecurityService
@inject NavigationManager Navigation


<div class="lock-screen d-flex justify-content-center align-items-center min-vh-100">
    <div class="card shadow" style="width: 100%; max-width: 400px;">
        <div class="card-header text-center bg-primary text-white">
            <h4 class="mb-0">
                <i class="oi oi-lock-locked me-2"></i>
                Journal App Locked
            </h4>
        </div>
        
        <div class="card-body text-center p-4">
            @if (!SecurityService.IsPinSet())
            {
                <!-- Setup PIN Screen -->
                <div class="setup-pin">
                    <i class="oi oi-key display-4 text-primary mb-3"></i>
                    <h5>Setup Security PIN</h5>
                    <p class="text-muted">Create a 4-digit PIN to protect your journal</p>
                    
                    <div class="mb-3">
                        <input type="password" class="form-control form-control-lg text-center" 
                               placeholder="Enter 4-digit PIN" 
                               maxlength="4"
                               @bind="newPin" 
                               @bind:event="oninput" 
                               @onkeyup="@((e) => { if(e.Key == "Enter") SetPin(); })" />
                    </div>
                    
                    <div class="mb-3">
                        <input type="password" class="form-control form-control-lg text-center" 
                               placeholder="Confirm PIN" 
                               maxlength="4"
                               @bind="confirmPin" 
                               @bind:event="oninput" 
                               @onkeyup="@((e) => { if(e.Key == "Enter") SetPin(); })" />
                    </div>
                    
                    <button class="btn btn-primary btn-lg w-100" @onclick="SetPin" disabled="@isProcessing">
                        @if (isProcessing)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                        }
                        Set PIN & Continue
                    </button>
                    
                    <button class="btn btn-link mt-2" @onclick="SkipSetup">
                        Skip for now
                    </button>
                    
                    @if (!string.IsNullOrEmpty(errorMessage))
                    {
                        <div class="alert alert-danger mt-3">
                            @errorMessage
                        </div>
                    }
                </div>
            }
            else
            {
                <!-- Unlock Screen -->
                <div class="unlock-pin">
                    <i class="oi oi-lock-locked display-4 text-primary mb-3"></i>
                    <h5>Enter PIN to Unlock</h5>
                    <p class="text-muted">Enter your 4-digit PIN to access your journal</p>
                    
                    <!-- PIN Display (dots) -->
                    <div class="pin-display mb-4">
                        <div class="d-flex justify-content-center">
                            @for (int i = 0; i < 4; i++)
                            {
                                <div class="pin-dot mx-2 @(i < enteredPin.Length ? "filled" : "")"></div>
                            }
                        </div>
                        <div class="pin-feedback mt-2">
                            @if (showError)
                            {
                                <span class="text-danger small">
                                    <i class="oi oi-warning"></i> Incorrect PIN
                                </span>
                            }
                        </div>
                    </div>
                    
                    <!-- Numeric Keypad -->
                    <div class="keypad">
                        <div class="row mb-2">
                            <div class="col-4">
                                <button class="btn btn-outline-secondary btn-key" 
                                        @onclick="@(() => AddDigit("1"))">
                                    1
                                </button>
                            </div>
                            <div class="col-4">
                                <button class="btn btn-outline-secondary btn-key" 
                                        @onclick="@(() => AddDigit("2"))">
                                    2
                                </button>
                            </div>
                            <div class="col-4">
                                <button class="btn btn-outline-secondary btn-key" 
                                        @onclick="@(() => AddDigit("3"))">
                                    3
                                </button>
                            </div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-4">
                                <button class="btn btn-outline-secondary btn-key" 
                                        @onclick="@(() => AddDigit("4"))">
                                    4
                                </button>
                            </div>
                            <div class="col-4">
                                <button class="btn btn-outline-secondary btn-key" 
                                        @onclick="@(() => AddDigit("5"))">
                                    5
                                </button>
                            </div>
                            <div class="col-4">
                                <button class="btn btn-outline-secondary btn-key" 
                                        @onclick="@(() => AddDigit("6"))">
                                    6
                                </button>
                            </div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-4">
                                <button class="btn btn-outline-secondary btn-key" 
                                        @onclick="@(() => AddDigit("7"))">
                                    7
                                </button>
                            </div>
                            <div class="col-4">
                                <button class="btn btn-outline-secondary btn-key" 
                                        @onclick="@(() => AddDigit("8"))">
                                    8
                                </button>
                            </div>
                            <div class="col-4">
                                <button class="btn btn-outline-secondary btn-key" 
                                        @onclick="@(() => AddDigit("9"))">
                                    9
                                </button>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-4">
                                <button class="btn btn-outline-secondary btn-key" @onclick="ClearPin">
                                    <i class="oi oi-delete"></i>
                                </button>
                            </div>
                            <div class="col-4">
                                <button class="btn btn-outline-secondary btn-key" 
                                        @onclick="@(() => AddDigit("0"))">
                                    0
                                </button>
                            </div>
                            <div class="col-4">
                                <button class="btn btn-primary btn-key" @onclick="VerifyPin" disabled="@(enteredPin.Length != 4)">
                                    <i class="oi oi-arrow-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <button class="btn btn-link" @onclick="ForgotPin">
                            Forgot PIN?
                        </button>
                    </div>
                </div>
            }
        </div>
        
        <div class="card-footer text-center text-muted small">
            Your journal entries are encrypted and secure
        </div>
    </div>
</div>

<style>
    .lock-screen {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .pin-dot {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        border: 2px solid #dee2e6;
        transition: all 0.2s;
    }
    
    .pin-dot.filled {
        background-color: #0d6efd;
        border-color: #0d6efd;
    }
    
    .btn-key {
        width: 70px;
        height: 70px;
        font-size: 1.5rem;
        border-radius: 50%;
        margin: 5px;
        transition: all 0.2s;
    }
    
    .btn-key:hover {
        transform: scale(1.05);
    }
    
    .btn-key:active {
        transform: scale(0.95);
    }
    
    .form-control-lg {
        font-size: 1.5rem;
        letter-spacing: 5px;
    }
</style>

@code {
    private string newPin = "";
    private string confirmPin = "";
    private string enteredPin = "";
    private string errorMessage = "";
    private bool showError = false;
    private bool isProcessing = false;
    
    private void AddDigit(string digit)
    {
        if (enteredPin.Length < 4)
        {
            enteredPin += digit;
            StateHasChanged();
        }
    }
    
    private void ClearPin()
    {
        enteredPin = "";
        showError = false;
        StateHasChanged();
    }
    
    private async Task VerifyPin()
    {
        if (enteredPin.Length != 4)
            return;
        
        isProcessing = true;
        StateHasChanged();
        
        await Task.Delay(300); // Small delay for UX
        
        var isValid = await SecurityService.VerifyPinAsync(enteredPin);
        
        if (isValid)
        {
            // Navigate to home/dashboard
            Navigation.NavigateTo("/", forceLoad: true);
        }
        else
        {
            showError = true;
            enteredPin = "";
            
            // Clear error after 2 seconds
            await Task.Delay(2000);
            showError = false;
        }
        
        isProcessing = false;
        StateHasChanged();
    }
    
    private async Task SetPin()
    {
        if (string.IsNullOrWhiteSpace(newPin) || newPin.Length != 4)
        {
            errorMessage = "Please enter a 4-digit PIN";
            return;
        }
        
        if (newPin != confirmPin)
        {
            errorMessage = "PINs do not match";
            return;
        }
        
        isProcessing = true;
        StateHasChanged();
        
        var success = await SecurityService.SetPinAsync(newPin);
        
        if (success)
        {
            Navigation.NavigateTo("/", forceLoad: true);
        }
        else
        {
            errorMessage = "Failed to set PIN. Please try again.";
            isProcessing = false;
            StateHasChanged();
        }
    }
    
    private void SkipSetup()
    {
        Navigation.NavigateTo("/", forceLoad: true);
    }
    
    private void ForgotPin()
    {
        // In a real app, you would have a recovery process
        // For now, just show a message
        errorMessage = "Please reinstall the app to reset PIN. All data will be lost.";
        StateHasChanged();
    }
}