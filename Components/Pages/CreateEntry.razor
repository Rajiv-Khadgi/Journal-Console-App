@* @page "/create"

@inject JournalService JournalService
@inject DailyLimitService LimitService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<h3>Create Journal Entry</h3>

@if (!canCreate)
{
    <div class="alert alert-warning">
        <h5>Cannot Create Entry Today</h5>
        <p>
            You have already created a journal entry today.
            Even if you deleted it, you cannot create another one today.
        </p>
        <div class="mt-2">
            <a href="/dashboard" class="btn btn-secondary">Go to Dashboard</a>
        </div>
    </div>
}
else
{
    <EditForm Model="entry" OnSubmit="CreateEntryAsync">

        <!-- TITLE -->
        <div class="mb-3">
            <label class="form-label">Title *</label>
            <input class="form-control" @bind="entry.Title" />
            @if (titleError)
            {
                <small class="text-danger">Title is required.</small>
            }
        </div>

        <!-- CONTENT -->
        <div class="mb-3">
            <label class="form-label">Content *</label>
            <div id="editor" class="border p-2" style="min-height: 200px;"></div>
            @if (contentError)
            {
                <small class="text-danger">Content cannot be empty.</small>
            }
        </div>

        <!-- PRIMARY MOOD -->
        <div class="mb-3">
            <label class="form-label">Primary Mood *</label>
            <select class="form-select" @bind="entry.PrimaryMood">
                <option value="">-- Select --</option>
                @foreach (var mood in primaryMoods)
                {
                    <option value="@mood">@mood</option>
                }
            </select>
            @if (primaryMoodError)
            {
                <small class="text-danger">Primary mood is required.</small>
            }
        </div>

        <!-- SECONDARY MOODS -->
        <div class="mb-3">
            <label>Secondary Moods (max 2, at least 1 required)</label>

            @foreach (var group in secondaryMoodCategories)
            {
                <br />
                <strong>@group.Key</strong>
                @foreach (var mood in group.Value)
                {
                    <div>
                        <input type="checkbox"
                               disabled="@IsSecondaryDisabled(mood)"
                               checked="@selectedSecondaryMoods.Contains(mood)"
                               @onchange="e => OnSecondaryMoodChanged(e, mood)" />
                        @mood
                    </div>
                }
            }

            @if (secondaryMoodError)
            {
                <small class="text-danger">Select at least one secondary mood.</small>
            }
        </div>

        <!-- TAGS -->
        <div class="mb-3">
            <label>Tags (optional)</label>

            @foreach (var tag in predefinedTags)
            {
                <label class="me-2">
                    <input type="checkbox"
                           checked="@selectedTags.Contains(tag)"
                           @onchange="e => OnTagChanged(e, tag)" />
                    @tag
                </label>
            }

            <div class="input-group mt-2">
                <input class="form-control" placeholder="Custom tag"
                       @bind="customTagInput" />
                <button type="button" class="btn btn-outline-secondary"
                        @onclick="AddCustomTag">
                    Add
                </button>
            </div>

            @foreach (var tag in selectedTags)
            {
                <span class="badge bg-secondary me-1">@tag</span>
            }
        </div>

        <button class="btn btn-primary">Save Entry</button>
    </EditForm>
}

@code {

    private JournalEntry entry = new() { EntryDate = DateTime.Today };
    private bool canCreate = true;
    private bool titleError;
    private bool contentError;
    private bool primaryMoodError;
    private bool secondaryMoodError;

    private readonly List<string> primaryMoods =
        new() { "Happy", "Sad", "Angry", "Relaxed", "Anxious" };

    private readonly Dictionary<string, List<string>> secondaryMoodCategories =
        new()
        {
            { "Positive", new() { "Excited", "Grateful", "Confident" } },
            { "Neutral", new() { "Calm", "Thoughtful" } },
            { "Negative", new() { "Lonely", "Stressed" } }
        };

    private List<string> selectedSecondaryMoods = new();

    private readonly List<string> predefinedTags =
        new() { "Work", "Career", "Studies", "Family", "Friends", "Relationships", "Health", "Fitness", "Personal Growth", "Self-care", "hobbies", "Travel", "Nature", "Finance", "Spirituality", "Birthday", "Holiday", "Vacation", "Celebration", "Exercise", "Reading", "Writing", "Cooking", "Meditation", "Yoga", "Music" };

    private List<string> selectedTags = new();
    private string customTagInput = "";

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            canCreate = await LimitService.CanCreateAsync();
            try { await JSRuntime.InvokeVoidAsync("initQuill"); }
            catch { }
        }
    }

    private void OnSecondaryMoodChanged(ChangeEventArgs e, string mood)
    {
        bool isChecked = e.Value is bool b && b;

        if (isChecked && selectedSecondaryMoods.Count < 2)
            selectedSecondaryMoods.Add(mood);
        else if (!isChecked)
            selectedSecondaryMoods.Remove(mood);
    }

    //catagory retrieve
    private string GetCategoryForMood(string moodName)
    {
        if (secondaryMoodCategories["Positive"].Contains(moodName))
            return "Positive";
        else if (secondaryMoodCategories["Neutral"].Contains(moodName))
            return "Neutral";
        else if (secondaryMoodCategories["Negative"].Contains(moodName))
            return "Negative";
        return "Unknown";
    }

    private bool IsSecondaryDisabled(string mood) =>
        selectedSecondaryMoods.Count >= 2 &&
        !selectedSecondaryMoods.Contains(mood);

    private void OnTagChanged(ChangeEventArgs e, string tag)
    {
        bool isChecked = e.Value is bool b && b;

        if (isChecked && !selectedTags.Contains(tag))
            selectedTags.Add(tag);
        else if (!isChecked)
            selectedTags.Remove(tag);
    }

    private void AddCustomTag()
    {
        var tag = customTagInput?.Trim();
        if (!string.IsNullOrWhiteSpace(tag) && !selectedTags.Contains(tag))
            selectedTags.Add(tag);

        customTagInput = "";
    }

    private async Task CreateEntryAsync()
    {
        // Title validation
        titleError = string.IsNullOrWhiteSpace(entry.Title);

        // Content validation
        var raw = await JSRuntime.InvokeAsync<string>("getQuillContent");

        var cleaned = raw
            .Replace("<p><br></p>", "")
            .Replace("<p></p>", "")
            .Replace("&nbsp;", "")
            .Trim();

        contentError = string.IsNullOrWhiteSpace(cleaned);


        // Primary mood validation
        primaryMoodError = string.IsNullOrWhiteSpace(entry.PrimaryMood);

        // Secondary mood validation (must select at least one)
        secondaryMoodError = selectedSecondaryMoods.Count == 0;

        // Stop if any errors
        if (titleError || contentError || primaryMoodError || secondaryMoodError) return;

        entry.Content = cleaned;

        var tags = selectedTags.Select(t => new Tag { TagName = t }).ToList();
        var moods = selectedSecondaryMoods.Select(m => new SecondaryMood { MoodName = m, Category = GetCategoryForMood(m) }).ToList();

        if (await JournalService.CreateEntryAsync(entry, tags, moods))
            Navigation.NavigateTo("/dashboard");
    }
}
 *@








@* 

@page "/create"

@inject JournalService JournalService
@inject DailyLimitService LimitService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<h3>Create Journal Entry</h3>

@if (!canCreate)
{
    <div class="alert alert-warning">
        <h5>Cannot Create Entry Today</h5>
        <p>
            You have already created a journal entry today.
            Even if you deleted it, you cannot create another one today.
        </p>
        <div class="mt-2">
            <a href="/dashboard" class="btn btn-secondary">Go to Dashboard</a>
        </div>
    </div>
}
else
{
    <EditForm Model="entry" OnSubmit="CreateEntryAsync">

        <!-- TITLE -->
        <div class="mb-3">
            <label class="form-label">Title *</label>
            <input class="form-control" @bind="entry.Title" />
            @if (titleError)
            {
                <small class="text-danger">Title is required.</small>
            }
        </div>

        <!-- CONTENT -->
        <div class="mb-3">
            <label class="form-label">Content *</label>
            <div id="editor" class="border p-2" style="min-height: 200px;"></div>
            @if (contentError)
            {
                <small class="text-danger">Content cannot be empty.</small>
            }
        </div>

        <!-- PRIMARY MOOD -->
        <div class="mb-3">
            <label class="form-label">Primary Mood *</label>
            <select class="form-select" @bind="entry.PrimaryMood">
                <option value="">-- Select --</option>
                @foreach (var mood in primaryMoods)
                {
                    <option value="@mood">@mood</option>
                }
            </select>
            @if (primaryMoodError)
            {
                <small class="text-danger">Primary mood is required.</small>
            }
        </div>

        <!-- SECONDARY MOODS -->
        <div class="mb-3">
            <label>Secondary Moods (max 2, at least 1 required)</label>

            @foreach (var group in secondaryMoodCategories)
            {
                <br />
                <strong>@group.Key</strong>
                @foreach (var mood in group.Value)
                {
                    <div>
                        <input type="checkbox"
                               disabled="@IsSecondaryDisabled(mood)"
                               checked="@selectedSecondaryMoods.Contains(mood)"
                               @onchange="e => OnSecondaryMoodChanged(e, mood)" />
                        @mood
                    </div>
                }
            }

            @if (secondaryMoodError)
            {
                <small class="text-danger">Select at least one secondary mood.</small>
            }
        </div>

        <!-- TAGS -->
        <div class="mb-3">
            <label>Tags (optional)</label>

            <!-- Predefined Tags Checkboxes -->
            <div class="mb-2">
                @foreach (var tag in predefinedTags)
                {
                    <label class="me-2">
                        <input type="checkbox"
                               checked="@selectedTags.Contains(tag)"
                               @onchange="e => OnTagChanged(e, tag)" />
                        @tag
                    </label>
                }
            </div>

            <!-- Custom Tag Input -->
            <div class="input-group mt-2 mb-2">
                <input class="form-control" placeholder="Custom tag"
                       @bind="customTagInput" />
                <button type="button" class="btn btn-outline-secondary"
                        @onclick="AddCustomTag">
                    Add
                </button>
            </div>

            <!-- Selected Tags with Remove Buttons - ALL TAGS -->
            @if (selectedTags.Any())
            {
                <div class="mt-2">
                    <small>Selected tags (click × to remove):</small><br />
                    @foreach (var tag in selectedTags)
                    {
                        <span class="badge bg-primary me-1 mb-1 d-inline-flex align-items-center">
                            @tag
                            <span style="cursor: pointer; margin-left: 6px; font-size: 1.1em;"
                                  @onclick="@(() => RemoveTag(tag))"
                                  title="Remove tag">
                                ×
                            </span>
                        </span>
                    }
                </div>
            }
        </div>

        <button class="btn btn-primary">Save Entry</button>
    </EditForm>
}

@code {

    private JournalEntry entry = new() { EntryDate = DateTime.Today };
    private bool canCreate = true;
    private bool titleError;
    private bool contentError;
    private bool primaryMoodError;
    private bool secondaryMoodError;

    private readonly List<string> primaryMoods =
        new() { "Happy", "Sad", "Angry", "Relaxed", "Anxious" };

    private readonly Dictionary<string, List<string>> secondaryMoodCategories =
        new()
        {
            { "Positive", new() { "Excited", "Grateful", "Confident" } },
            { "Neutral", new() { "Calm", "Thoughtful" } },
            { "Negative", new() { "Lonely", "Stressed" } }
        };

    private List<string> selectedSecondaryMoods = new();

    private readonly List<string> predefinedTags =
        new() { "Work", "Career", "Studies", "Family", "Friends", "Relationships", "Health", "Fitness", "Personal Growth", "Self-care", "hobbies", "Travel", "Nature", "Finance", "Spirituality", "Birthday", "Holiday", "Vacation", "Celebration", "Exercise", "Reading", "Writing", "Cooking", "Meditation", "Yoga", "Music" };

    private List<string> selectedTags = new();
    private string customTagInput = "";

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            canCreate = await LimitService.CanCreateAsync();
            try { await JSRuntime.InvokeVoidAsync("initQuill"); }
            catch { }
        }
    }

    private void OnSecondaryMoodChanged(ChangeEventArgs e, string mood)
    {
        bool isChecked = e.Value is bool b && b;

        if (isChecked && selectedSecondaryMoods.Count < 2)
            selectedSecondaryMoods.Add(mood);
        else if (!isChecked)
            selectedSecondaryMoods.Remove(mood);
    }

    //catagory retrieve
    private string GetCategoryForMood(string moodName)
    {
        if (secondaryMoodCategories["Positive"].Contains(moodName))
            return "Positive";
        else if (secondaryMoodCategories["Neutral"].Contains(moodName))
            return "Neutral";
        else if (secondaryMoodCategories["Negative"].Contains(moodName))
            return "Negative";
        return "Unknown";
    }

    private bool IsSecondaryDisabled(string mood) =>
        selectedSecondaryMoods.Count >= 2 &&
        !selectedSecondaryMoods.Contains(mood);

    private void OnTagChanged(ChangeEventArgs e, string tag)
    {
        bool isChecked = e.Value is bool b && b;

        if (isChecked && !selectedTags.Contains(tag))
            selectedTags.Add(tag);
        else if (!isChecked)
            selectedTags.Remove(tag);
    }

    private void AddCustomTag()
    {
        var tag = customTagInput?.Trim();
        if (!string.IsNullOrWhiteSpace(tag) && !selectedTags.Contains(tag))
            selectedTags.Add(tag);

        customTagInput = "";
    }


    private void RemoveTag(string tag)
    {
        selectedTags.Remove(tag);
    }

    private async Task CreateEntryAsync()
    {
        // Title validation
        titleError = string.IsNullOrWhiteSpace(entry.Title);

        // Content validation
        var raw = await JSRuntime.InvokeAsync<string>("getQuillContent");

        var cleaned = raw
            .Replace("<p><br></p>", "")
            .Replace("<p></p>", "")
            .Replace("&nbsp;", "")
            .Trim();

        contentError = string.IsNullOrWhiteSpace(cleaned);


        // Primary mood validation
        primaryMoodError = string.IsNullOrWhiteSpace(entry.PrimaryMood);

        // Secondary mood validation (must select at least one)
        secondaryMoodError = selectedSecondaryMoods.Count == 0;

        // Stop if any errors
        if (titleError || contentError || primaryMoodError || secondaryMoodError) return;

        entry.Content = cleaned;

        var tags = selectedTags.Select(t => new Tag { TagName = t }).ToList();
        var moods = selectedSecondaryMoods.Select(m => new SecondaryMood { MoodName = m, Category = GetCategoryForMood(m) }).ToList();

        if (await JournalService.CreateEntryAsync(entry, tags, moods))
            Navigation.NavigateTo("/dashboard");
    }
} *@



@* 
@page "/create"
@inject JournalService JournalService
@inject DailyLimitService LimitService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<div class="create-entry-page">
    <!-- Header -->
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="page-title">
                    <i class="bi bi-pencil-square me-2"></i>Create Journal Entry
                </h1>
                <p class="page-subtitle">Write your thoughts, track your mood, and reflect on your day</p>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-secondary" @onclick="NavigateToDashboard">
                    <i class="bi bi-x-lg me-1"></i>Cancel
                </button>
                <button class="btn btn-primary" @onclick="CreateEntryAsync">
                    <i class="bi bi-save me-1"></i>Save Entry
                </button>
            </div>
        </div>

        <!-- Stats Bar -->
        <div class="stats-bar">
            <div class="d-flex flex-wrap gap-4">
                <div class="stat-item">
                    <span class="stat-label">Today's Date:</span>
                    <span class="stat-value">@DateTime.Now.ToString("dddd, MMMM d, yyyy")</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Status:</span>
                    <span class="stat-value text-success">Ready to write</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Daily Limit:</span>
                    <span class="stat-value">1 entry per day</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    @if (!canCreate)
    {
        <!-- Limit Reached -->
        <div class="limit-alert">
            <div class="alert-card">
                <div class="alert-icon">
                    <i class="bi bi-calendar-x"></i>
                </div>
                <div class="alert-content">
                    <h3>Daily Limit Reached</h3>
                    <p>You've already created an entry today. Journaling is great, but moderation is key! Come back tomorrow.</p>
                    <div class="alert-actions">
                        <a href="/dashboard" class="btn btn-primary">
                            <i class="bi bi-journal-text me-1"></i>View Your Entries
                        </a>
                        <a href="/calendar" class="btn btn-outline-primary">
                            <i class="bi bi-calendar3 me-1"></i>Browse Calendar
                        </a>
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <!-- Entry Form -->
        <div class="entry-form">
            <div class="row">
                <!-- Left Column - Main Content -->
                <div class="col-lg-8">
                    <!-- Title Section -->
                    <div class="form-section">
                        <div class="section-header">
                            <h3>
                                <i class="bi bi-type me-2"></i>
                                Entry Title
                                <span class="required-badge">Required</span>
                            </h3>
                        </div>
                        <div class="section-body">
                            <div class="form-group">
                                <input class="form-control title-input"
                                       placeholder="What's on your mind today?"
                                       @bind="entry.Title" />
                                @if (titleError)
                                {
                                    <div class="validation-error">
                                        <i class="bi bi-exclamation-triangle me-1"></i>
                                        Please enter a title for your entry
                                    </div>
                                }
                            </div>
                        </div>
                    </div>

                    <!-- Content Editor -->
                    <div class="form-section">
                        <div class="section-header">
                            <h3>
                                <i class="bi bi-text-paragraph me-2"></i>
                                Your Thoughts
                                <span class="required-badge">Required</span>
                            </h3>
                            <div class="editor-stats">
                                <span id="wordCount">0 words</span>
                                <span id="charCount">0 characters</span>
                            </div>
                        </div>
                        <div class="section-body">
                            <div class="quill-container">
                                <div id="editor"></div>
                                @if (contentError)
                                {
                                    <div class="validation-error">
                                        <i class="bi bi-exclamation-triangle me-1"></i>
                                        Please write something in your entry
                                    </div>
                                }
                            </div>
                            <div class="editor-tips">
                                <i class="bi bi-lightbulb"></i>
                                <span>Tip: Write freely - this is your personal space for reflection</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column - Metadata -->
                <div class="col-lg-4">
                    <!-- Mood Selection -->
                    <div class="form-section">
                        <div class="section-header">
                            <h3>
                                <i class="bi bi-emoji-smile me-2"></i>
                                How are you feeling?
                            </h3>
                        </div>
                        <div class="section-body">
                            <!-- Primary Mood -->
                            <div class="form-group">
                                <label class="form-label">Primary Mood <span class="required-badge">Required</span></label>
                                <div class="mood-grid">
                                    @foreach (var mood in primaryMoods)
                                    {
                                        <div class="mood-option @(entry.PrimaryMood == mood ? "selected" : "")"
                                             @onclick="() => entry.PrimaryMood = mood">
                                            <div class="mood-icon">
                                                @GetMoodIcon(mood)
                                            </div>
                                            <div class="mood-name">@mood</div>
                                        </div>
                                    }
                                </div>
                                @if (primaryMoodError)
                                {
                                    <div class="validation-error">
                                        <i class="bi bi-exclamation-triangle me-1"></i>
                                        Please select your primary mood
                                    </div>
                                }
                            </div>

                            <!-- Secondary Moods -->
                            <div class="form-group">
                                <label class="form-label">
                                    Secondary Moods
                                    <span class="sub-label">(select 1-2)</span>
                                    <span class="required-badge">Required</span>
                                </label>
                                @foreach (var group in secondaryMoodCategories)
                                {
                                    <div class="mood-category">
                                        <h6>@group.Key</h6>
                                        <div class="mood-list">
                                            @foreach (var mood in group.Value)
                                            {
                                                <div class="mood-checkbox">
                                                    <input type="checkbox"
                                                           id="mood_@mood"
                                                           disabled="@IsSecondaryDisabled(mood)"
                                                           checked="@selectedSecondaryMoods.Contains(mood)"
                                                           @onchange="e => OnSecondaryMoodChanged(e, mood)" />
                                                    <label for="mood_@mood" class="mood-label @(IsSecondaryDisabled(mood) ? "disabled" : "")">
                                                        @mood
                                                    </label>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                }
                                @if (secondaryMoodError)
                                {
                                    <div class="validation-error">
                                        <i class="bi bi-exclamation-triangle me-1"></i>
                                        Please select at least one secondary mood
                                    </div>
                                }
                            </div>
                        </div>
                    </div>

                    <!-- Tags -->
                    <div class="form-section">
                        <div class="section-header">
                            <h3>
                                <i class="bi bi-tags me-2"></i>
                                Tags
                                <span class="optional-badge">Optional</span>
                            </h3>
                        </div>
                        <div class="section-body">
                            <!-- Selected Tags -->
                            @if (selectedTags.Any())
                            {
                                <div class="selected-tags mb-3">
                                    <h6>Selected Tags</h6>
                                    <div class="tags-container">
                                        @foreach (var tag in selectedTags)
                                        {
                                            <div class="tag-item">
                                                <span>@tag</span>
                                                <button class="tag-remove" @onclick="() => RemoveTag(tag)">
                                                    <i class="bi bi-x"></i>
                                                </button>
                                            </div>
                                        }
                                    </div>
                                </div>
                            }

                            <!-- Add Custom Tag -->
                            <div class="custom-tag-input">
                                <div class="input-group">
                                    <input class="form-control"
                                           placeholder="Add custom tag..."
                                           @bind="customTagInput"
                                           @onkeypress="@((e) => { if (e.Key == "Enter") AddCustomTag(); })" />
                                    <button class="btn btn-outline-primary" @onclick="AddCustomTag">
                                        <i class="bi bi-plus"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Popular Tags -->
                            <div class="popular-tags mt-3">
                                <h6>Popular Tags</h6>
                                <div class="tags-suggestions">
                                    @foreach (var tag in predefinedTags)
                                    {
                                        <button class="tag-suggestion @(selectedTags.Contains(tag) ? "selected" : "")"
                                                @onclick="() => ToggleTag(tag)">
                                            @tag
                                        </button>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<style>
    /* Page Layout */
    .create-entry-page {
        padding: 2rem;
        background-color: #f8f9fa;
        min-height: 100vh;
    }

    /* Header */
    .page-header {
        margin-bottom: 2rem;
    }

    .page-title {
        font-weight: 700;
        color: #2c3e50;
        margin-bottom: 0.5rem;
    }

    .page-subtitle {
        color: #6c757d;
        font-size: 1.1rem;
    }

    .stats-bar {
        background: white;
        padding: 1rem 1.5rem;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        margin-top: 1rem;
    }

    .stat-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .stat-label {
        font-weight: 600;
        color: #495057;
    }

    .stat-value {
        color: #6c757d;
    }

    /* Limit Alert */
    .limit-alert {
        max-width: 800px;
        margin: 3rem auto;
    }

    .alert-card {
        background: white;
        border-radius: 16px;
        padding: 3rem;
        text-align: center;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }

    .alert-icon {
        font-size: 4rem;
        color: #ffc107;
        margin-bottom: 1.5rem;
    }

    .alert-content h3 {
        color: #2c3e50;
        margin-bottom: 1rem;
    }

    .alert-content p {
        color: #6c757d;
        font-size: 1.1rem;
        line-height: 1.6;
        margin-bottom: 2rem;
    }

    .alert-actions {
        display: flex;
        gap: 1rem;
        justify-content: center;
    }

    /* Form Sections */
    .form-section {
        background: white;
        border-radius: 12px;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        overflow: hidden;
    }

    .section-header {
        padding: 1.25rem 1.5rem;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-bottom: 1px solid #dee2e6;
    }

        .section-header h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
            margin: 0;
            display: flex;
            align-items: center;
        }

    .section-body {
        padding: 1.5rem;
    }

    /* Badges */
    .required-badge {
        background: #dc3545;
        color: white;
        padding: 0.2rem 0.6rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
        margin-left: 0.5rem;
    }

    .optional-badge {
        background: #6c757d;
        color: white;
        padding: 0.2rem 0.6rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
        margin-left: 0.5rem;
    }

    /* Title Input */
    .title-input {
        border: none;
        border-bottom: 2px solid #dee2e6;
        border-radius: 0;
        padding: 0.75rem 0;
        font-size: 1.5rem;
        font-weight: 600;
        color: #2c3e50;
        transition: all 0.3s ease;
    }

        .title-input:focus {
            outline: none;
            border-bottom-color: #4dabf7;
            box-shadow: none;
        }

        .title-input::placeholder {
            color: #adb5bd;
            font-weight: 400;
        }

    /* Quill Editor */
    .quill-container {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        overflow: hidden;
    }

    .editor-stats {
        display: flex;
        gap: 1rem;
        margin-left: auto;
        font-size: 0.85rem;
        color: #6c757d;
    }

    .editor-tips {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem;
        background: #e7f3ff;
        border-radius: 6px;
        margin-top: 1rem;
        color: #0d6efd;
        font-size: 0.9rem;
    }

        .editor-tips i {
            font-size: 1.1rem;
        }

    /* Mood Selection */
    .mood-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 0.75rem;
    }

    .mood-option {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 1rem;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        background: white;
    }

        .mood-option:hover {
            border-color: #4dabf7;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(77, 171, 247, 0.1);
        }

        .mood-option.selected {
            border-color: #4dabf7;
            background: #e7f3ff;
        }

    .mood-icon {
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }

    .mood-name {
        font-size: 0.9rem;
        font-weight: 500;
        color: #495057;
    }

    .mood-category {
        margin-bottom: 1rem;
    }

        .mood-category h6 {
            color: #6c757d;
            font-weight: 600;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            font-size: 0.8rem;
        }

    .mood-list {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }

    .mood-checkbox {
        display: flex;
        align-items: center;
        margin: 0.25rem;
    }

    .mood-label {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.25rem 0.25rem;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 15px;
        cursor: pointer;
        font-size: 0.9rem;
        color: #495057;
        transition: all 0.2s ease;
    }

        .mood-label:hover {
            background: #e9ecef;
        }

        .mood-label.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

    /* Tags */
    .tags-container {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }

    .tag-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background: #4dabf7;
        color: white;
        padding: 0.4rem 0.8rem;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 500;
    }

    .tag-remove {
        background: none;
        border: none;
        color: white;
        cursor: pointer;
        padding: 0;
        width: 18px;
        height: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: background-color 0.2s ease;
    }

        .tag-remove:hover {
            background: rgba(255, 255, 255, 0.2);
        }

    .custom-tag-input {
        margin-bottom: 1rem;
    }

    .tags-suggestions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }

    .tag-suggestion {
        padding: 0.3rem 0.6rem;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 12px;
        font-size: 0.8rem;
        color: #495057;
        cursor: pointer;
        transition: all 0.2s ease;
    }

        .tag-suggestion:hover {
            background: #e9ecef;
        }

        .tag-suggestion.selected {
            background: #4dabf7;
            color: white;
            border-color: #4dabf7;
        }

    /* Validation */
    .validation-error {
        display: flex;
        align-items: center;
        color: #dc3545;
        font-size: 0.85rem;
        margin-top: 0.5rem;
        padding: 0.5rem;
        background: #fff5f5;
        border-radius: 4px;
    }

    /* Form Labels */
    .form-label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 600;
        color: #495057;
        margin-bottom: 0.75rem;
    }

    .sub-label {
        font-weight: 400;
        color: #6c757d;
        font-size: 0.85rem;
    }

    /* Animations */
    @@keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    @@keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Responsive Design */
    @@media (max-width: 992px) {
        .create-entry-page {
            padding: 1rem;
        }

        .mood-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @@media (max-width: 768px) {
        .page-title {
            font-size: 1.5rem;
        }

        .stats-bar {
            padding: 0.75rem 1rem;
        }

        .alert-card {
            padding: 2rem 1rem;
        }

        .alert-actions {
            flex-direction: column;
        }
    }
</style>

@code {
    private JournalEntry entry = new() { EntryDate = DateTime.Today };
    private bool canCreate = true;
    private bool titleError;
    private bool contentError;
    private bool primaryMoodError;
    private bool secondaryMoodError;

    private readonly List<string> primaryMoods = new() { "Happy", "Sad", "Angry", "Relaxed", "Anxious" };

    private readonly Dictionary<string, List<string>> secondaryMoodCategories = new()
    {
        { "Positive", new() { "Excited", "Grateful", "Confident", "Happy", "Relaxed" } },
        { "Neutral", new() { "Calm", "Thoughtful", "Curious", "Nostalgic", "Bored" } },
        { "Negative", new() { "Lonely", "Stressed", "Sad", "Angry" } }
    };

    private List<string> selectedSecondaryMoods = new();
    private readonly List<string> predefinedTags = new() {
        "Work", "Career", "Studies", "Family", "Friends", "Relationships",
        "Health", "Fitness", "Personal Growth", "Self-care", "Hobbies", "Travel",
        "Nature", "Finance", "Spirituality", "Birthday", "Holiday", "Vacation",
        "Celebration", "Exercise", "Reading", "Writing", "Cooking", "Meditation",
        "Yoga", "Music"
    };

    private List<string> selectedTags = new();
    private string customTagInput = "";

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            canCreate = await LimitService.CanCreateAsync();
            try
            {
                await JSRuntime.InvokeVoidAsync("initQuill", DotNetObjectReference.Create(this));
            }
            catch
            {
                // Handle Quill initialization error
            }
        }
    }

    private string GetMoodIcon(string mood)
    {
        return mood.ToLower() switch
        {
            "happy" => "😊",
            "sad" => "😔",
            "angry" => "😠",
            "relaxed" => "😌",
            "anxious" => "😰",
            _ => "😐"
        };
    }

    private void OnSecondaryMoodChanged(ChangeEventArgs e, string mood)
    {
        bool isChecked = e.Value is bool b && b;

        if (isChecked && selectedSecondaryMoods.Count < 2)
            selectedSecondaryMoods.Add(mood);
        else if (!isChecked)
            selectedSecondaryMoods.Remove(mood);
    }

    private string GetCategoryForMood(string moodName)
    {
        if (secondaryMoodCategories["Positive"].Contains(moodName))
            return "Positive";
        else if (secondaryMoodCategories["Neutral"].Contains(moodName))
            return "Neutral";
        else if (secondaryMoodCategories["Negative"].Contains(moodName))
            return "Negative";
        return "Unknown";
    }

    private bool IsSecondaryDisabled(string mood) =>
        selectedSecondaryMoods.Count >= 2 && !selectedSecondaryMoods.Contains(mood);

    private void ToggleTag(string tag)
    {
        if (selectedTags.Contains(tag))
            selectedTags.Remove(tag);
        else
            selectedTags.Add(tag);
    }

    private void AddCustomTag()
    {
        var tag = customTagInput?.Trim();
        if (!string.IsNullOrWhiteSpace(tag) && !selectedTags.Contains(tag))
            selectedTags.Add(tag);

        customTagInput = "";
    }

    private void RemoveTag(string tag)
    {
        selectedTags.Remove(tag);
    }

    private void ClearForm()
    {
        entry = new() { EntryDate = DateTime.Today };
        selectedSecondaryMoods.Clear();
        selectedTags.Clear();
        customTagInput = "";
        titleError = contentError = primaryMoodError = secondaryMoodError = false;
    }

    private void NavigateToDashboard()
    {
        Navigation.NavigateTo("/dashboard");
    }

    private async Task CreateEntryAsync()
    {
        // Validation
        titleError = string.IsNullOrWhiteSpace(entry.Title);

        var raw = await JSRuntime.InvokeAsync<string>("getQuillContent");
        var cleaned = raw
            .Replace("<p><br></p>", "")
            .Replace("<p></p>", "")
            .Replace("&nbsp;", "")
            .Trim();
        contentError = string.IsNullOrWhiteSpace(cleaned);

        primaryMoodError = string.IsNullOrWhiteSpace(entry.PrimaryMood);
        secondaryMoodError = selectedSecondaryMoods.Count == 0;

        // Stop if any errors
        if (titleError || contentError || primaryMoodError || secondaryMoodError)
        {
            StateHasChanged();
            return;
        }

        entry.Content = cleaned;

        var tags = selectedTags.Select(t => new Tag { TagName = t }).ToList();
        var moods = selectedSecondaryMoods.Select(m => new SecondaryMood
        {
            MoodName = m,
            Category = GetCategoryForMood(m)
        }).ToList();

        if (await JournalService.CreateEntryAsync(entry, tags, moods))
        {
            Navigation.NavigateTo("/dashboard");
        }
    }

    // JS Interop methods for Quill stats
    [JSInvokable]
    public void UpdateWordCount(int words, int characters)
    {
        // You could implement word/character counting here
    }
} *@





@page "/create"
@inject JournalService JournalService
@inject DailyLimitService LimitService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<div class="create-entry-page">
    <!-- Header -->
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="page-title">
                    <i class="bi bi-pencil-square me-2"></i>Create Journal Entry
                </h1>
                <p class="page-subtitle">Write your thoughts, track your mood, and reflect on your day</p>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-secondary" @onclick="NavigateToDashboard">
                    <i class="bi bi-x-lg me-1"></i>Cancel
                </button>
                <button class="btn btn-primary" @onclick="CreateEntryAsync">
                    <i class="bi bi-save me-1"></i>Save Entry
                </button>
            </div>
        </div>

        <!-- Stats Bar -->
        <div class="stats-bar">
            <div class="d-flex flex-wrap gap-4">
                <div class="stat-item">
                    <span class="stat-label">Today's Date:</span>
                    <span class="stat-value">@DateTime.Now.ToString("dddd, MMMM d, yyyy")</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Daily Limit:</span>
                    <span class="stat-value">1 entry per day</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    @if (!canCreate)
    {
        <!-- Limit Reached -->
        <div class="limit-alert">
            <div class="alert-card">
                <div class="alert-icon">
                    <i class="bi bi-calendar-x"></i>
                </div>
                <div class="alert-content">
                    <h3>Daily Limit Reached</h3>
                    <p>You've already created an entry today. Journaling is great, but moderation is key! Come back tomorrow.</p>
                    <div class="alert-actions">
                        <a href="/dashboard" class="btn btn-primary">
                            <i class="bi bi-journal-text me-1"></i>View Your Entries
                        </a>
                        <a href="/calendar" class="btn btn-outline-primary">
                            <i class="bi bi-calendar3 me-1"></i>Browse Calendar
                        </a>
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <!-- Entry Form -->
        <div class="entry-form">
            <div class="row">
                <!-- Left Column - Main Content -->
                <div class="col-lg-8">
                    <!-- Title Section -->
                    <div class="form-section">
                        <div class="section-header">
                            <h3>
                                <i class="bi bi-type me-2"></i>
                                Entry Title
                                <span class="required-badge">Required</span>
                            </h3>
                        </div>
                        <div class="section-body">
                            <div class="form-group">
                                <input class="form-control title-input"
                                       placeholder="What's on your mind today?"
                                       @bind="entry.Title" />
                                @if (titleError)
                                {
                                    <div class="validation-error">
                                        <i class="bi bi-exclamation-triangle me-1"></i>
                                        Please enter a title for your entry
                                    </div>
                                }
                            </div>
                        </div>
                    </div>

                    <!-- Tags Section -->
                    <div class="form-section">
                        <div class="section-header">
                            <h3>
                                <i class="bi bi-tags me-2"></i>
                                Tags
                                <span class="optional-badge">Optional</span>
                            </h3>
                        </div>
                        <div class="section-body">
                            <!-- Selected Tags -->
                            @if (selectedTags.Any())
                            {
                                <div class="selected-tags mb-3">
                                    <h6>Selected Tags</h6>
                                    <div class="tags-container">
                                        @foreach (var tag in selectedTags)
                                        {
                                            <div class="tag-item">
                                                <span>@tag</span>
                                                <button class="tag-remove" @onclick="() => RemoveTag(tag)">
                                                    <i class="bi bi-x"></i>
                                                </button>
                                            </div>
                                        }
                                    </div>
                                </div>
                            }

                            <!-- Add Custom Tag -->
                            <div class="custom-tag-input">
                                <div class="input-group">
                                    <input class="form-control"
                                           placeholder="Add custom tag..."
                                           @bind="customTagInput"
                                           @onkeypress="@((e) => { if (e.Key == "Enter") AddCustomTag(); })" />
                                    <button class="btn btn-outline-primary" @onclick="AddCustomTag">
                                        <i class="bi bi-plus"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Popular Tags -->
                            <div class="popular-tags mt-3">
                                <h6>Popular Tags</h6>
                                <div class="tags-suggestions">
                                    @foreach (var tag in predefinedTags)
                                    {
                                        <button class="tag-suggestion @(selectedTags.Contains(tag) ? "selected" : "")"
                                                @onclick="() => ToggleTag(tag)">
                                            @tag
                                        </button>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Content Editor -->
                    <div class="form-section">
                        <div class="section-header">
                            <h3>
                                <i class="bi bi-text-paragraph me-2"></i>
                                Your Thoughts
                                <span class="required-badge">Required</span>
                            </h3>
                            <div class="editor-stats">
                                <span id="wordCount">0 words</span>
                                <span id="charCount">0 characters</span>
                            </div>
                        </div>
                        <div class="section-body">
                            <div class="quill-container">
                                <div id="editor"></div>
                                @if (contentError)
                                {
                                    <div class="validation-error">
                                        <i class="bi bi-exclamation-triangle me-1"></i>
                                        Please write something in your entry
                                    </div>
                                }
                            </div>
                            <div class="editor-tips">
                                <i class="bi bi-lightbulb"></i>
                                <span>Tip: Write freely - this is your personal space for reflection</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column - Mood Selection Only -->
                <div class="col-lg-4">
                    <!-- Mood Selection -->
                    <div class="form-section">
                        <div class="section-header">
                            <h3>
                                <i class="bi bi-emoji-smile me-2"></i>
                                How are you feeling?
                            </h3>
                        </div>
                        <div class="section-body">
                            <!-- Primary Mood -->
                            <div class="form-group">
                                <label class="form-label">Primary Mood <span class="required-badge">Required</span></label>
                                <div class="mood-grid">
                                    @foreach (var mood in primaryMoods)
                                    {
                                        <div class="mood-option @(entry.PrimaryMood == mood ? "selected" : "")"
                                             @onclick="() => entry.PrimaryMood = mood">
                                            <div class="mood-icon">
                                                @GetMoodIcon(mood)
                                            </div>
                                            <div class="mood-name">@mood</div>
                                        </div>
                                    }
                                </div>
                                @if (primaryMoodError)
                                {
                                    <div class="validation-error">
                                        <i class="bi bi-exclamation-triangle me-1"></i>
                                        Please select your primary mood
                                    </div>
                                }
                            </div>

                            <!-- Secondary Moods -->
                            <div class="form-group">
                                <label class="form-label">
                                    Secondary Moods
                                    <span class="sub-label">(select 1-2)</span>
                                    <span class="required-badge">Required</span>
                                </label>
                                @foreach (var group in secondaryMoodCategories)
                                {
                                    <div class="mood-category">
                                        <h6>@group.Key</h6>
                                        <div class="mood-list">
                                            @foreach (var mood in group.Value)
                                            {
                                                <div class="mood-checkbox">
                                                    <input type="checkbox"
                                                           disabled="@IsSecondaryDisabled(mood)"
                                                           checked="@selectedSecondaryMoods.Contains(mood)"
                                                           @onchange="e => OnSecondaryMoodChanged(e, mood)" />
                                                    <label class="mood-label @(IsSecondaryDisabled(mood) ? "disabled" : "")">
                                                        @mood
                                                    </label>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                }
                                @if (secondaryMoodError)
                                {
                                    <div class="validation-error">
                                        <i class="bi bi-exclamation-triangle me-1"></i>
                                        Please select at least one secondary mood
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<style>
    /* Page Layout */
    .create-entry-page {
        padding: 2rem;
        background-color: #f8f9fa;
        min-height: 100vh;
    }

    /* Header */
    .page-header {
        margin-bottom: 2rem;
    }

    .page-title {
        font-weight: 700;
        color: #2c3e50;
        margin-bottom: 0.5rem;
    }

    .page-subtitle {
        color: #6c757d;
        font-size: 1.1rem;
    }

    .stats-bar {
        background: white;
        padding: 1rem 1.5rem;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        margin-top: 1rem;
    }

    .stat-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .stat-label {
        font-weight: 600;
        color: #495057;
    }

    .stat-value {
        color: #6c757d;
    }

    /* Limit Alert */
    .limit-alert {
        max-width: 800px;
        margin: 3rem auto;
    }

    .alert-card {
        background: white;
        border-radius: 16px;
        padding: 3rem;
        text-align: center;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }

    .alert-icon {
        font-size: 4rem;
        color: #ffc107;
        margin-bottom: 1.5rem;
    }

    .alert-content h3 {
        color: #2c3e50;
        margin-bottom: 1rem;
    }

    .alert-content p {
        color: #6c757d;
        font-size: 1.1rem;
        line-height: 1.6;
        margin-bottom: 2rem;
    }

    .alert-actions {
        display: flex;
        gap: 1rem;
        justify-content: center;
    }

    /* Form Sections */
    .form-section {
        background: white;
        border-radius: 12px;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        overflow: hidden;
    }

    .section-header {
        padding: 1.25rem 1.5rem;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-bottom: 1px solid #dee2e6;
    }

        .section-header h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
            margin: 0;
            display: flex;
            align-items: center;
        }

    .section-body {
        padding: 1.5rem;
    }

    /* Badges */
    .required-badge {
        background: #dc3545;
        color: white;
        padding: 0.2rem 0.6rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
        margin-left: 0.5rem;
    }

    .optional-badge {
        background: #6c757d;
        color: white;
        padding: 0.2rem 0.6rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
        margin-left: 0.5rem;
    }

    /* Title Input */
    .title-input {
        border: none;
        border-bottom: 2px solid #dee2e6;
        border-radius: 0;
        padding: 0.5rem 0; /* Reduced height */
        font-size: 1.25rem; /* Smaller font */
        font-weight: 600;
        color: #2c3e50;
        transition: all 0.3s ease;
    }

        .title-input:focus {
            outline: none;
            border-bottom-color: #4dabf7;
            box-shadow: none;
        }

        .title-input::placeholder {
            color: #adb5bd;
            font-weight: 400;
        }

    /* Quill Editor */
    .quill-container {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        overflow: hidden;
    }

    .editor-stats {
        display: flex;
        gap: 1rem;
        margin-left: auto;
        font-size: 0.85rem;
        color: #6c757d;
    }

    .editor-tips {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem;
        background: #e7f3ff;
        border-radius: 6px;
        margin-top: 1rem;
        color: #0d6efd;
        font-size: 0.9rem;
    }

        .editor-tips i {
            font-size: 1.1rem;
        }

    /* Tags Section */
    .tags-container {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .tag-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background: #4dabf7;
        color: white;
        padding: 0.3rem 0.6rem; /* Reduced padding */
        border-radius: 20px;
        font-size: 0.8rem; /* Smaller font */
        font-weight: 500;
        transition: all 0.2s ease;
    }

        .tag-item:hover {
            background: #3d9be5;
            transform: translateY(-1px);
        }

    .tag-remove {
        background: none;
        border: none;
        color: white;
        cursor: pointer;
        padding: 0;
        width: 18px;
        height: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: background-color 0.2s ease;
        font-size: 0.8rem;
    }

        .tag-remove:hover {
            background: rgba(255, 255, 255, 0.3);
        }

    .custom-tag-input {
        margin-bottom: 1rem;
    }

        .custom-tag-input .input-group {
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #dee2e6;
        }

        .custom-tag-input .form-control {
            border: none;
            padding: 0.5rem 1rem; /* Reduced padding */
            font-size: 0.9rem;
        }

        .custom-tag-input .btn {
            border: none;
            background: #f8f9fa;
            color: #495057;
            padding: 0.5rem 0.75rem;
        }

            .custom-tag-input .btn:hover {
                background: #e9ecef;
            }

    .tags-suggestions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        max-height: 100px; /* Reduced height */
        overflow-y: auto;
        padding: 0.5rem;
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #dee2e6;
    }

    .tag-suggestion {
        padding: 0.3rem 0.6rem; /* Reduced padding */
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 12px;
        font-size: 0.8rem; /* Smaller font */
        color: #495057;
        cursor: pointer;
        transition: all 0.2s ease;
    }

        .tag-suggestion:hover {
            background: #e9ecef;
            transform: translateY(-1px);
        }

        .tag-suggestion.selected {
            background: #4dabf7;
            color: white;
            border-color: #4dabf7;
        }

    .popular-tags h6 {
        color: #6c757d;
        font-weight: 600;
        margin-bottom: 0.75rem;
        font-size: 0.9rem;
    }

    .selected-tags h6 {
        color: #495057;
        font-weight: 600;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
    }

    /* Mood Selection */
    .mood-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 0.75rem;
        margin-bottom: 1.5rem;
    }

    .mood-option {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 0.75rem; /* Reduced padding */
        border: 2px solid #e9ecef;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        background: white;
    }

        .mood-option:hover {
            border-color: #4dabf7;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(77, 171, 247, 0.1);
        }

        .mood-option.selected {
            border-color: #4dabf7;
            background: #e7f3ff;
        }

    .mood-icon {
        font-size: 1.5rem; /* Smaller icon */
        margin-bottom: 0.25rem; /* Reduced margin */
    }

    .mood-name {
        font-size: 0.85rem; /* Smaller font */
        font-weight: 500;
        color: #495057;
    }

    .mood-category {
        margin-bottom: 1rem;
    }

        .mood-category h6 {
            color: #6c757d;
            font-weight: 600;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            font-size: 0.8rem;
        }

    .mood-list {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }

    /* FIXED: Mood Checkbox - Now clickable */
    .mood-checkbox {
        display: inline-block;
        margin: 0.25rem;
        position: relative;
    }

        /* Make checkbox invisible but still clickable */
        .mood-checkbox input[type="checkbox"] {
            opacity: 0;
            position: absolute;
            width: 100%;
            height: 100%;
            cursor: pointer;
            z-index: 2;
            margin: 0;
            top: 0;
            left: 0;
        }

    .mood-label {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.4rem 0.75rem; /* Reduced padding */
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 15px;
        cursor: pointer;
        font-size: 0.85rem; /* Smaller font */
        color: #495057;
        transition: all 0.2s ease;
        position: relative;
        z-index: 1;
    }

        /* Custom checkbox indicator */
        .mood-label::before {
            content: "";
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #adb5bd;
            border-radius: 4px;
            background: white;
            transition: all 0.2s ease;
        }

    /* Checked state */
    .mood-checkbox input[type="checkbox"]:checked + .mood-label::before {
        background-color: #4dabf7;
        border-color: #4dabf7;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3E%3Cpath d='M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z'/%3E%3C/svg%3E");
        background-size: 12px;
        background-repeat: no-repeat;
        background-position: center;
    }

    .mood-checkbox input[type="checkbox"]:checked + .mood-label {
        background: #e7f3ff;
        border-color: #4dabf7;
        color: #4dabf7;
        font-weight: 500;
    }

    .mood-label:hover {
        background: #e9ecef;
    }

    .mood-label.disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* Validation */
    .validation-error {
        display: flex;
        align-items: center;
        color: #dc3545;
        font-size: 0.85rem;
        margin-top: 0.5rem;
        padding: 0.5rem;
        background: #fff5f5;
        border-radius: 4px;
    }

    /* Form Labels */
    .form-label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 600;
        color: #495057;
        margin-bottom: 0.75rem;
    }

    .sub-label {
        font-weight: 400;
        color: #6c757d;
        font-size: 0.85rem;
    }

    /* Animations */
    @@keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    @@keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Responsive Design */
    @@media (max-width: 992px) {
        .create-entry-page {
            padding: 1rem;
        }

        .mood-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        .tags-suggestions {
            max-height: 100px;
        }
    }

    @@media (max-width: 768px) {
        .page-title {
            font-size: 1.5rem;
        }

        .stats-bar {
            padding: 0.75rem 1rem;
        }

        .alert-card {
            padding: 2rem 1rem;
        }

        .alert-actions {
            flex-direction: column;
        }

        .mood-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }

        .mood-option {
            padding: 0.75rem;
        }

        .mood-icon {
            font-size: 1.5rem;
        }
    }
</style>

@code {
    private JournalEntry entry = new() { EntryDate = DateTime.Today };
    private bool canCreate = true;
    private bool titleError;
    private bool contentError;
    private bool primaryMoodError;
    private bool secondaryMoodError;

    private readonly List<string> primaryMoods = new() { "Happy", "Sad", "Angry", "Relaxed", "Anxious" };

    private readonly Dictionary<string, List<string>> secondaryMoodCategories = new()
    {
        { "Positive", new() { "Excited", "Grateful", "Confident", "Happy", "Relaxed" } },
        { "Neutral", new() { "Calm", "Thoughtful", "Curious", "Nostalgic", "Bored" } },
        { "Negative", new() { "Lonely", "Stressed", "Sad", "Angry" } }
    };

    private List<string> selectedSecondaryMoods = new();
    private readonly List<string> predefinedTags = new() {
        "Work", "Career", "Studies", "Family", "Friends", "Relationships",
        "Health", "Fitness", "Personal Growth", "Self-care", "Hobbies", "Travel",
        "Nature", "Finance", "Spirituality", "Birthday", "Holiday", "Vacation",
        "Celebration", "Exercise", "Reading", "Writing", "Cooking", "Meditation",
        "Yoga", "Music"
    };

    private List<string> selectedTags = new();
    private string customTagInput = "";

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            canCreate = await LimitService.CanCreateAsync();
            try
            {
                await JSRuntime.InvokeVoidAsync("initQuill", DotNetObjectReference.Create(this));
            }
            catch
            {
                // Handle Quill initialization error
            }
        }
    }

    private string GetMoodIcon(string mood)
    {
        return mood.ToLower() switch
        {
            "happy" => "😊",
            "sad" => "😔",
            "angry" => "😠",
            "relaxed" => "😌",
            "anxious" => "😰",
            _ => "😐"
        };
    }

    private void OnSecondaryMoodChanged(ChangeEventArgs e, string mood)
    {
        bool isChecked = e.Value is bool b && b;

        if (isChecked && selectedSecondaryMoods.Count < 2)
            selectedSecondaryMoods.Add(mood);
        else if (!isChecked)
            selectedSecondaryMoods.Remove(mood);
    }

    private string GetCategoryForMood(string moodName)
    {
        if (secondaryMoodCategories["Positive"].Contains(moodName))
            return "Positive";
        else if (secondaryMoodCategories["Neutral"].Contains(moodName))
            return "Neutral";
        else if (secondaryMoodCategories["Negative"].Contains(moodName))
            return "Negative";
        return "Unknown";
    }

    private bool IsSecondaryDisabled(string mood) =>
        selectedSecondaryMoods.Count >= 2 && !selectedSecondaryMoods.Contains(mood);

    private void ToggleTag(string tag)
    {
        if (selectedTags.Contains(tag))
            selectedTags.Remove(tag);
        else
            selectedTags.Add(tag);
    }

    private void AddCustomTag()
    {
        var tag = customTagInput?.Trim();
        if (!string.IsNullOrWhiteSpace(tag) && !selectedTags.Contains(tag))
            selectedTags.Add(tag);

        customTagInput = "";
    }

    private void RemoveTag(string tag)
    {
        selectedTags.Remove(tag);
    }

    private void ClearForm()
    {
        entry = new() { EntryDate = DateTime.Today };
        selectedSecondaryMoods.Clear();
        selectedTags.Clear();
        customTagInput = "";
        titleError = contentError = primaryMoodError = secondaryMoodError = false;
    }

    private void NavigateToDashboard()
    {
        Navigation.NavigateTo("/dashboard");
    }

    private async Task CreateEntryAsync()
    {
        // Validation
        titleError = string.IsNullOrWhiteSpace(entry.Title);

        var raw = await JSRuntime.InvokeAsync<string>("getQuillContent");
        var cleaned = raw
            .Replace("<p><br></p>", "")
            .Replace("<p></p>", "")
            .Replace("&nbsp;", "")
            .Trim();
        contentError = string.IsNullOrWhiteSpace(cleaned);

        primaryMoodError = string.IsNullOrWhiteSpace(entry.PrimaryMood);
        secondaryMoodError = selectedSecondaryMoods.Count == 0;

        // Stop if any errors
        if (titleError || contentError || primaryMoodError || secondaryMoodError)
        {
            StateHasChanged();
            return;
        }

        entry.Content = cleaned;

        var tags = selectedTags.Select(t => new Tag { TagName = t }).ToList();
        var moods = selectedSecondaryMoods.Select(m => new SecondaryMood
        {
            MoodName = m,
            Category = GetCategoryForMood(m)
        }).ToList();

        if (await JournalService.CreateEntryAsync(entry, tags, moods))
        {
            Navigation.NavigateTo("/dashboard");
        }
    }

 
}