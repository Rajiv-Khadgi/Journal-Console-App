@page "/export"
@inject JournalService JournalService
@inject PdfExportService PdfExportService
@inject NavigationManager Navigation

<h3>Export Journal Entries</h3>

<div class="card">
    <div class="card-header">
        <h5>Export Options</h5>
    </div>
    <div class="card-body">
        <!-- EXPORT TYPE SELECTION -->
        <!-- EXPORT TYPE SELECTION -->
        <div class="mb-4">
            <label class="form-label fw-bold">Export Type</label>
            <div class="form-check mb-2">
                <input class="form-check-input" type="radio" name="exportType"
                       checked="@(exportType == ExportType.DateRange)"
                       @onchange="@(() => { exportType = ExportType.DateRange; LoadPreview(); })" />
                <label class="form-check-label">
                    Date Range
                </label>
            </div>
            <div class="form-check mb-2">
                <input class="form-check-input" type="radio" name="exportType"
                       checked="@(exportType == ExportType.AllEntries)"
                       @onchange="@(() => { exportType = ExportType.AllEntries; LoadPreview(); })" />
                <label class="form-check-label">
                    All Entries
                </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="exportType"
                       checked="@(exportType == ExportType.LastMonth)"
                       @onchange="@(() => { exportType = ExportType.LastMonth; LoadPreview(); })" />
                <label class="form-check-label">
                    Last 30 Days
                </label>
            </div>
        </div>

        <!-- DATE RANGE SELECTION (Visible only for DateRange type) -->
        @if (exportType == ExportType.DateRange)
        {
            <div class="row mb-4">
                <div class="col-md-6">
                    <label class="form-label">From Date</label>
                    <input type="date" class="form-control" 
                           @bind="startDate" @bind:format="yyyy-MM-dd" />
                </div>
                <div class="col-md-6">
                    <label class="form-label">To Date</label>
                    <input type="date" class="form-control" 
                           @bind="endDate" @bind:format="yyyy-MM-dd" />
                </div>
            </div>
        }

        <!-- PREVIEW STATS -->
        @if (!isLoading && entries != null)
        {
            <div class="alert alert-info">
                <h6>Export Preview</h6>
                <p class="mb-1">Entries to export: <strong>@entries.Count</strong></p>
                <p class="mb-0">Date range: <strong>@GetExportRangeText()</strong></p>
            </div>
        }

        <!-- ACTION BUTTONS -->
        <div class="d-grid gap-2 d-md-flex justify-content-md-start">
            <button class="btn btn-primary" @onclick="LoadPreview" 
                    disabled="@isLoading">
                @if (isLoading)
                {
                    <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                }
                Preview Export
            </button>
            
            @if (entries != null && entries.Any())
            {
                <button class="btn btn-success" @onclick="ExportToPdf">
                    <i class="oi oi-cloud-download me-1"></i> Export to PDF
                </button>
            }
        </div>

        <!-- RESULT MESSAGE -->
        @if (!string.IsNullOrEmpty(exportResult))
        {
            <div class="alert @(exportResult.Contains("successfully") ? "alert-success" : "alert-danger") mt-3">
                @exportResult
            </div>
        }
    </div>
</div>

<style>
    .form-check-input:checked {
        background-color: #0d6efd;
        border-color: #0d6efd;
    }
    
    .btn:disabled {
        opacity: 0.65;
    }
</style>

@code {
    private List<JournalEntry>? entries;
    private bool isLoading = false;
    private string exportResult = "";
    
    // Export settings
    private ExportType exportType = ExportType.DateRange;
    private DateTime startDate = DateTime.Today.AddMonths(-1);
    private DateTime endDate = DateTime.Today;
    
    private enum ExportType
    {
        DateRange,
        AllEntries,
        LastMonth
    }
    
    protected override async Task OnInitializedAsync()
    {
        await LoadPreview();
    }
    
    private async Task LoadPreview()
    {
        isLoading = true;
        exportResult = "";
        StateHasChanged();
        
        try
        {
            var allEntries = await JournalService.GetAllEntriesWithDetailsAsync();
            
            switch (exportType)
            {
                case ExportType.DateRange:
                    entries = allEntries
                        .Where(e => e.EntryDate.Date >= startDate.Date && e.EntryDate.Date <= endDate.Date)
                        .ToList();
                    break;
                    
                case ExportType.AllEntries:
                    entries = allEntries;
                    break;
                    
                case ExportType.LastMonth:
                    var lastMonthStart = DateTime.Today.AddDays(-30);
                    entries = allEntries
                        .Where(e => e.EntryDate.Date >= lastMonthStart.Date && e.EntryDate.Date <= DateTime.Today)
                        .ToList();
                    break;
            }
        }
        catch (Exception ex)
        {
            exportResult = $"Error loading entries: {ex.Message}";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
    
    private async Task ExportToPdf()
    {
        if (entries == null || !entries.Any())
            return;
            
        isLoading = true;
        exportResult = "";
        StateHasChanged();
        
        try
        {
            string filePath;
            
            if (exportType == ExportType.DateRange)
            {
                filePath = await PdfExportService.ExportDateRangeToPdf(entries, startDate, endDate);
            }
            else
            {
                filePath = await PdfExportService.ExportEntriesToPdf(entries, GetExportTitle());
            }
            
            exportResult = $" PDF exported successfully! File saved to: {filePath}";
            
            // Optionally: Open the file or show download option
            // For MAUI, you might want to use Launcher to open the file
        }
        catch (Exception ex)
        {
            exportResult = $" Export failed: {ex.Message}";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
    
    private string GetExportRangeText()
    {
        return exportType switch
        {
            ExportType.DateRange => $"{startDate:MMM dd, yyyy} to {endDate:MMM dd, yyyy}",
            ExportType.AllEntries => "All entries",
            ExportType.LastMonth => "Last 30 days",
            _ => "Custom range"
        };
    }
    
    private string GetExportTitle()
    {
        return exportType switch
        {
            ExportType.DateRange => $"Journal Entries ({startDate:MMM dd, yyyy} to {endDate:MMM dd, yyyy})",
            ExportType.AllEntries => "All Journal Entries",
            ExportType.LastMonth => "Journal Entries - Last 30 Days",
            _ => "Journal Export"
        };
    }
}