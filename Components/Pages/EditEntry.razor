@page "/edit/{Id:int}"

@inject JournalService JournalService
@inject DailyLimitService LimitService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<h3>Edit Journal Entry</h3>

@if (entry == null)
{
    <p>Loading entry...</p>
}
else if (!canEdit)
{
    <p class="text-danger">You have already edited a journal today.</p>
}
else
{
    <EditForm Model="entry" OnSubmit="UpdateEntryAsync">

        <!-- TITLE -->
        <div class="mb-3">
            <label class="form-label">Title *</label>
            <InputText class="form-control" @bind-Value="entry.Title" />
            @if (titleError)
            {
                <small class="text-danger">Title is required.</small>
            }
        </div>

        <!-- CONTENT -->
        <div class="mb-3">
            <label class="form-label">Content *</label>
            <div id="editor" class="border p-2" style="min-height: 200px;"></div>
            @if (contentError)
            {
                <small class="text-danger">Content cannot be empty.</small>
            }
        </div>

        <!-- PRIMARY MOOD -->
        <div class="mb-3">
            <label class="form-label">Primary Mood *</label>
            <select class="form-select" @bind="entry.PrimaryMood">
                <option value="">-- Select --</option>
                @foreach (var mood in primaryMoods)
                {
                    <option value="@mood" selected="@(entry.PrimaryMood == mood)">@mood</option>
                }
            </select>
            @if (primaryMoodError)
            {
                <small class="text-danger">Primary mood is required.</small>
            }
        </div>

        <!-- SECONDARY MOODS -->
        <div class="mb-3">
            <label>Secondary Moods (max 2)</label>

            @foreach (var group in secondaryMoodCategories)
            {
                <br />
                <strong>@group.Key</strong>
                @foreach (var mood in group.Value)
                {
                    <div>
                        <input type="checkbox"
                               disabled="@IsSecondaryDisabled(mood)"
                               checked="@selectedSecondaryMoods.Contains(mood)"
                               @onchange="e => OnSecondaryMoodChanged(e, mood)" />
                        @mood
                    </div>
                }
            }
        </div>

        <!-- TAGS -->
        <div class="mb-3">
            <label>Tags</label>

            @foreach (var tag in predefinedTags)
            {
                <label class="me-2">
                    <input type="checkbox"
                           checked="@selectedTags.Contains(tag)"
                           @onchange="e => OnTagChanged(e, tag)" />
                    @tag
                </label>
            }

            <div class="input-group mt-2">
                <input class="form-control" placeholder="Custom tag"
                       @bind="customTagInput" />
                <button type="button" class="btn btn-outline-secondary"
                        @onclick="AddCustomTag">
                    Add
                </button>
            </div>

            @foreach (var tag in selectedTags)
            {
                <span class="badge bg-secondary me-1">@tag</span>
            }
        </div>

        <button class="btn btn-primary">Update Entry</button>
    </EditForm>
}

@code {
    [Parameter] public int Id { get; set; }

    private JournalEntry? entry;
    private bool canEdit = true;

    private bool titleError;
    private bool contentError;
    private bool primaryMoodError;

    private readonly List<string> primaryMoods =
        new() { "Happy", "Sad", "Angry", "Relaxed", "Anxious" };

    private readonly Dictionary<string, List<string>> secondaryMoodCategories =
        new()
        {
            { "Positive", new() { "Excited", "Grateful", "Confident" } },
            { "Neutral", new() { "Calm", "Thoughtful" } },
            { "Negative", new() { "Lonely", "Stressed" } }
        };

    private List<string> selectedSecondaryMoods = new();

    private readonly List<string> predefinedTags =
        new() { "Work", "Health", "Study", "Travel" };

    private List<string> selectedTags = new();
    private string customTagInput = "";

    protected override async Task OnInitializedAsync()
    {
        entry = await JournalService.GetEntryWithDetailsAsync(Id);
        if (entry == null) return;

        selectedSecondaryMoods = entry.SecondaryMoods.Select(m => m.MoodName).ToList();
        selectedTags = entry.Tags.Select(t => t.TagName).ToList();

        canEdit = await LimitService.CanUpdateAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && entry != null)
        {
            // Simple delay and initialization
            await Task.Delay(50);
            await JSRuntime.InvokeVoidAsync("initQuillWithContent", entry.Content);
        }
    }

    private void OnSecondaryMoodChanged(ChangeEventArgs e, string mood)
    {
        bool isChecked = e.Value is bool b && b;

        if (isChecked && selectedSecondaryMoods.Count < 2)
            selectedSecondaryMoods.Add(mood);
        else if (!isChecked)
            selectedSecondaryMoods.Remove(mood);
    }

    //category retrive 
    private string GetCategoryForMood(string moodName)
    {
        if (secondaryMoodCategories["Positive"].Contains(moodName))
            return "Positive";
        else if (secondaryMoodCategories["Neutral"].Contains(moodName))
            return "Neutral";
        else if (secondaryMoodCategories["Negative"].Contains(moodName))
            return "Negative";
        return "Unknown";
    }

    private bool IsSecondaryDisabled(string mood) =>
        selectedSecondaryMoods.Count >= 2 &&
        !selectedSecondaryMoods.Contains(mood);

    private void OnTagChanged(ChangeEventArgs e, string tag)
    {
        bool isChecked = e.Value is bool b && b;

        if (isChecked && !selectedTags.Contains(tag))
            selectedTags.Add(tag);
        else if (!isChecked)
            selectedTags.Remove(tag);
    }

    private void AddCustomTag()
    {
        var tag = customTagInput?.Trim();
        if (!string.IsNullOrWhiteSpace(tag) && !selectedTags.Contains(tag))
            selectedTags.Add(tag);

        customTagInput = "";
    }

    private async Task UpdateEntryAsync()
    {
        titleError = string.IsNullOrWhiteSpace(entry!.Title);

        var raw = await JSRuntime.InvokeAsync<string>("getQuillContent");
        var cleaned = raw.Replace("<p><br></p>", "").Trim();
        contentError = string.IsNullOrWhiteSpace(cleaned);

        primaryMoodError = string.IsNullOrWhiteSpace(entry.PrimaryMood);

        if (titleError || contentError || primaryMoodError) return;

        entry.Content = cleaned;

        var tags = selectedTags.Select(t => new Tag { TagName = t }).ToList();
        var moods = selectedSecondaryMoods.Select(m => new SecondaryMood { MoodName = m, Category = GetCategoryForMood(m) }).ToList();

        if (await JournalService.UpdateEntryAsync(entry, tags, moods))
            Navigation.NavigateTo("/dashboard");
    }
}