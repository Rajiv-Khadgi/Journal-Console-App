@* @page "/dashboard"
@inject JournalService JournalService
@inject DailyLimitService LimitService
@inject NavigationManager Navigation

<h3>Journal Dashboard</h3>

@if (entries == null)
{
    <p>Loading entries...</p>
}
else if (!entries.Any())
{
    <p>No journal entries found. Create one!</p>
}
else
{
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Title</th>
                <th>Date</th>
                <th>Primary Mood</th>
                <th>Secondary Moods</th>
                <th>Tags</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var e in entries)
            {
                <tr>
                    <td>@e.Title</td>
                    <td>@e.EntryDate.ToShortDateString()</td>
                    <td>@e.PrimaryMood</td>
                    <td>
                        @foreach (var mood in e.SecondaryMoods)
                        {
                            <span class="badge bg-info me-1">@mood.MoodName</span>
                        }
                    </td>
                    <td>
                        @foreach (var tag in e.Tags)
                        {
                            <span class="badge bg-secondary me-1">@tag.TagName</span>
                        }
                    </td>
                    <td>
                        <button class="btn btn-sm btn-primary me-1" @onclick="() => EditEntry(e.Id)">Edit</button>
                        <button class="btn btn-sm btn-danger" @onclick="() => DeleteEntry(e.Id)">Delete</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    private List<JournalEntry>? entries;

    protected override async Task OnInitializedAsync()
    {
        await LoadEntriesAsync();
    }

    private async Task LoadEntriesAsync()
    {
        entries = await JournalService.GetAllEntriesWithDetailsAsync();
    }

    private void EditEntry(int id)
    {
        Navigation.NavigateTo($"/edit/{id}");
    }

    private async Task DeleteEntry(int id)
    {
        // Check if can delete today
        if (!await LimitService.CanDeleteAsync())
        {
            // Show alert (you can use JS interop for better alerts)
            Console.WriteLine("Cannot delete: You have already deleted an entry today.");
            return;
        }

        var entry = await JournalService.GetEntryByIdAsync(id);
        if (entry != null)
        {
            // Simple confirmation (you can use JS confirm for better UX)
            var confirm = true; // Replace with actual confirmation dialog

            if (confirm)
            {
                await JournalService.DeleteEntryAsync(entry);
                await LoadEntriesAsync();
            }
        }
    }
} *@





@page "/dashboard"
@inject JournalService JournalService
@inject DailyLimitService LimitService
@inject NavigationManager Navigation

<h3>Journal Dashboard</h3>

<!-- SEARCH AND FILTER BAR -->
<div class="row mb-3">
    <div class="col-md-6">
        <div class="input-group">
            <input type="text" class="form-control" placeholder="Search entries..." 
                   @bind="searchTerm" @bind:event="oninput" />
            <button class="btn btn-outline-secondary" type="button" @onclick="ApplyFilter">
                <i class="oi oi-magnifying-glass"></i>
            </button>
        </div>
    </div>
    <div class="col-md-3">
        <select class="form-select" @bind="itemsPerPage" @bind:after="ApplyFilter">
            <option value="5">5 per page</option>
            <option value="10" selected>10 per page</option>
            <option value="20">20 per page</option>
            <option value="50">50 per page</option>
        </select>
    </div>
    <div class="col-md-3">
        <select class="form-select" @bind="sortBy" @bind:after="ApplyFilter">
            <option value="date_desc">Newest First</option>
            <option value="date_asc">Oldest First</option>
            <option value="title">Title A-Z</option>
            <option value="mood">By Mood</option>
        </select>
    </div>
</div>

@if (entries == null)
{
    <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading entries...</span>
        </div>
        <p class="mt-2">Loading your journal entries...</p>
    </div>
}
else if (!filteredEntries.Any())
{
    <div class="alert alert-info">
        <h5>No Journal Entries Found</h5>
        <p>You haven't created any journal entries yet.</p>
        <a href="/create" class="btn btn-primary">Create Your First Entry</a>
    </div>
}
else
{
    <!-- ENTRIES TABLE -->
    <div class="table-responsive">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>Title</th>
                    <th>Date</th>
                    <th>Primary Mood</th>
                    <th>Secondary Moods</th>
                    <th>Tags</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var entry in pagedEntries)
                {
                    <tr class="clickable-row" @onclick="() => ViewEntry(entry.Id)" style="cursor: pointer;">
                        <td class="fw-bold">@entry.Title</td>
                        <td>@entry.EntryDate.ToString("MMM dd, yyyy")</td>
                        <td>
                            <span class="badge" style="background-color: @GetMoodColor(entry.PrimaryMood);">
                                @entry.PrimaryMood
                            </span>
                        </td>
                        <td>
                            @foreach (var mood in entry.SecondaryMoods.Take(2))
                            {
                                <span class="badge bg-secondary me-1">@mood.MoodName</span>
                            }
                            @if (entry.SecondaryMoods.Count > 2)
                            {
                                <span class="badge bg-light text-dark">+@(entry.SecondaryMoods.Count - 2)</span>
                            }
                        </td>
                        <td>
                            @foreach (var tag in entry.Tags.Take(3))
                            {
                                <span class="badge bg-light text-dark me-1">@tag.TagName</span>
                            }
                            @if (entry.Tags.Count > 3)
                            {
                                <span class="badge bg-light text-dark">+@(entry.Tags.Count - 3)</span>
                            }
                        </td>
                        <td @onclick:stopPropagation>
                            <button class="btn btn-primary btn-sm me-1" @onclick="() => EditEntry(entry.Id)">
                                Edit
                            </button>
                            <button class="btn btn-danger btn-sm" @onclick="() => DeleteEntry(entry.Id)">
                                Delete
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <!-- PAGINATION CONTROLS -->
    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
            <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                <button class="page-link" @onclick="() => ChangePage(currentPage - 1)" 
                        @onclick:preventDefault>
                    &laquo; Previous
                </button>
            </li>
            
            @for (int i = 1; i <= totalPages; i++)
            {
                <li class="page-item @(currentPage == i ? "active" : "")">
                    <button class="page-link" @onclick="() => ChangePage(i)" 
                            @onclick:preventDefault>@i</button>
                </li>
            }
            
            <li class="page-item @(currentPage >= totalPages ? "disabled" : "")">
                <button class="page-link" @onclick="() => ChangePage(currentPage + 1)" 
                        @onclick:preventDefault>
                    Next &raquo;
                </button>
            </li>
        </ul>
    </nav>
    
    <div class="text-center text-muted mt-2">
        Showing @((currentPage - 1) * itemsPerPage + 1) to 
        @Math.Min(currentPage * itemsPerPage, filteredEntries.Count) 
        of @filteredEntries.Count entries
    </div>
}

<style>
    .clickable-row:hover {
        background-color: rgba(0, 123, 255, 0.05);
        transition: background-color 0.2s;
    }
    
    .badge {
        font-size: 0.85em;
        font-weight: 500;
    }
    
    .btn-group .btn {
        border-radius: 4px !important;
        margin: 1px;
    }
</style>

@code {
    private List<JournalEntry>? entries;
    private List<JournalEntry> filteredEntries = new();
    private List<JournalEntry> pagedEntries = new();
    
    // Pagination
    private int currentPage = 1;
    private int itemsPerPage = 10;
    private int totalPages = 1;
    
    // Search & Sort
    private string searchTerm = "";
    private string sortBy = "date_desc";
    
    protected override async Task OnInitializedAsync()
    {
        await LoadEntriesAsync();
    }
    
    private async Task LoadEntriesAsync()
    {
        entries = await JournalService.GetAllEntriesWithDetailsAsync();
        ApplyFilterAndPagination();
    }
    
    private void ApplyFilter()
    {
        ApplyFilterAndPagination();
    }
    
    private void ApplyFilterAndPagination()
    {
        if (entries == null) return;
        
        // Apply search filter
        filteredEntries = entries
            .Where(e => string.IsNullOrWhiteSpace(searchTerm) || 
                       e.Title.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                       e.Content.Contains(searchTerm, StringComparison.OrdinalIgnoreCase))
            .ToList();
        
        // Apply sorting
        filteredEntries = sortBy switch
        {
            "date_asc" => filteredEntries.OrderBy(e => e.EntryDate).ToList(),
            "title" => filteredEntries.OrderBy(e => e.Title).ToList(),
            "mood" => filteredEntries.OrderBy(e => e.PrimaryMood).ToList(),
            _ => filteredEntries.OrderByDescending(e => e.EntryDate).ToList() // date_desc default
        };
        
        // Calculate pagination
        totalPages = (int)Math.Ceiling((double)filteredEntries.Count / itemsPerPage);
        if (currentPage > totalPages && totalPages > 0)
            currentPage = Math.Max(1, totalPages);
        
        // Get current page items
        pagedEntries = filteredEntries
            .Skip((currentPage - 1) * itemsPerPage)
            .Take(itemsPerPage)
            .ToList();
    }
    
    private void ChangePage(int page)
    {
        if (page < 1 || page > totalPages) return;
        
        currentPage = page;
        ApplyFilterAndPagination();
    }
    
    private void ViewEntry(int id)
    {
        Navigation.NavigateTo($"/view/{id}");
    }
    
    private void EditEntry(int id)
    {
        Navigation.NavigateTo($"/edit/{id}");
    }
    
    private async Task DeleteEntry(int id)
    {
        if (!await LimitService.CanDeleteAsync())
        {
            // Show error message
            Console.WriteLine("Cannot delete: You have already deleted an entry today.");
            return;
        }

        var entry = await JournalService.GetEntryByIdAsync(id);
        if (entry != null)
        {
            // Simple confirmation
            var confirm = true; // For now, always confirm
            
            if (confirm)
            {
                await JournalService.DeleteEntryAsync(entry);
                await LoadEntriesAsync(); // Reload the list
            }
        }
    }
    
    private string GetMoodColor(string mood)
    {
        return mood.ToLower() switch
        {
            "happy" => "#28a745",
            "sad" => "#6f42c1",
            "angry" => "#dc3545",
            "relaxed" => "#17a2b8",
            "anxious" => "#fd7e14",
            _ => "#6c757d"
        };
    }
}