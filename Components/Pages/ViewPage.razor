@page "/view/{Id:int}"
@inject JournalService JournalService
@inject PdfExportService PdfExportService
@inject NavigationManager Navigation
@inject DailyLimitService LimitService

<h3>View Journal Entry</h3>

@if (entry == null)
{
    <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading entry...</span>
        </div>
        <p class="mt-3 text-muted">Retrieving your memory...</p>
    </div>
}
else
{
    <div class="container pb-5">
        @if (!string.IsNullOrEmpty(limitErrorMessage))
        {
            <div class="alert alert-warning alert-dismissible fade show mb-4 shadow-sm" role="alert">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                @limitErrorMessage
                <button type="button" class="btn-close" @onclick='() => limitErrorMessage = ""' aria-label="Close"></button>
            </div>
        }

        <!-- Actions Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <button class="btn btn-outline-secondary" @onclick="GoBack">
                <i class="bi bi-arrow-left me-1"></i> Back
            </button>
            <div class="d-flex gap-2">
                 <button class="btn btn-outline-primary" @onclick="() => ExportEntry(entry.Id)">
                    <i class="bi bi-download me-1"></i> Export
                </button>
                <button class="btn btn-primary" @onclick="() => EditEntry(entry.Id)">
                    <i class="bi bi-pencil me-1"></i> Edit
                </button>
                <button class="btn btn-danger" @onclick="() => DeleteEntry(entry.Id)">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        </div>

        <!-- Paper Entry View -->
        <div class="paper-card shadow-sm mx-auto">
            <!-- Header -->
            <div class="paper-header border-bottom pb-4 mb-4">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div class="date-badge">
                        <span class="day">@entry.EntryDate.Day</span>
                        <span class="month">@entry.EntryDate.ToString("MMM").ToUpper()</span>
                        <span class="year">@entry.EntryDate.Year</span>
                    </div>
                    <div class="meta-badges text-end">
                        <span class="badge rounded-pill bg-light text-dark border mb-1">
                            <i class="bi bi-emoji-smile me-1"></i>@entry.PrimaryMood
                        </span>
                        <div class="text-muted small mt-1">
                            <i class="bi bi-clock me-1"></i>@entry.EntryDate.ToString("hh:mm tt")
                        </div>
                    </div>
                </div>
                
                <h1 class="entry-title">@entry.Title</h1>
                
                @if (entry.Tags.Any())
                {
                    <div class="mt-3">
                        @foreach (var tag in entry.Tags)
                        {
                            <span class="badge bg-light text-secondary me-2 fw-normal">
                                <i class="bi bi-tag me-1"></i>@tag.TagName
                            </span>
                        }
                    </div>
                }
            </div>

            <!-- Content -->
            <div class="paper-body">
                <div class="entry-content">
                    @((MarkupString)entry.Content)
                </div>
            </div>

            <!-- Footer -->
            @if (entry.SecondaryMoods.Any())
            {
                <div class="paper-footer border-top pt-4 mt-5">
                    <h6 class="text-muted text-uppercase small fw-bold mb-3">Additional Moods</h6>
                    <div class="d-flex flex-wrap gap-2">
                        @foreach (var mood in entry.SecondaryMoods)
                        {
                            <span class="badge rounded-pill bg-light text-secondary border">
                                @mood.MoodName
                            </span>
                        }
                    </div>
                </div>
            }
        </div>
    </div>
}

<style>
    .paper-card {
        background: white;
        border-radius: 8px;
        padding: 3rem;
        max-width: 800px;
        min-height: 80vh;
        position: relative;
    }

    /* Date Badge */
    .date-badge {
        display: flex;
        flex-direction: column;
        align-items: center;
        border: 2px solid var(--primary-color);
        border-radius: 8px;
        padding: 0.5rem 1rem;
        color: var(--primary-color);
        line-height: 1;
    }

    .date-badge .day {
        font-size: 1.8rem;
        font-weight: 700;
    }

    .date-badge .month {
        font-size: 0.8rem;
        font-weight: 600;
        margin: 2px 0;
    }

    .date-badge .year {
        font-size: 0.8rem;
        opacity: 0.8;
    }

    .entry-title {
        font-family: 'Georgia', serif; /* Or a nice display font */
        font-weight: 700;
        color: var(--text-color);
        line-height: 1.3;
    }

    .entry-content {
        font-family: 'Merriweather', 'Georgia', serif;
        font-size: 1.15rem;
        line-height: 1.8;
        color: #2c3e50;
    }
    
    [data-theme="dark"] .entry-content {
        color: #e0e0e0;
    }
    
    [data-theme="dark"] .paper-card {
        background: #1e1e1e;
        border: 1px solid #333;
    }

    /* Typography niceties */
    .entry-content p { margin-bottom: 1.5rem; }
    .entry-content blockquote {
        border-left: 4px solid var(--primary-color);
        padding-left: 1.5rem;
        font-style: italic;
        color: #6c757d;
    }
</style>

@code {
    [Parameter] public int Id { get; set; }
    private JournalEntry? entry;
    private string limitErrorMessage = "";

    protected override async Task OnParametersSetAsync()
    {
        await LoadEntry();
    }

    private async Task LoadEntry()
    {
        entry = await JournalService.GetEntryWithDetailsAsync(Id);
    }

    private void EditEntry(int id)
    {
        Navigation.NavigateTo($"/edit/{id}");
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/dashboard");
    }

    private async Task DeleteEntry(int id)
    {
        // Check limit first
        if (!await LimitService.CanDeleteAsync())
        {
            limitErrorMessage = "You have already deleted an entry today. You can only delete one entry per day.";
            StateHasChanged();
            return;
        }

        var entryToDelete = await JournalService.GetEntryByIdAsync(id);
        if (entryToDelete != null)
        {
            // Simple confirmation modal can be added later, for now just delete
            await JournalService.DeleteEntryAsync(entryToDelete);
            Navigation.NavigateTo("/dashboard");
        }
    }

    private async Task ExportEntry(int id)
{
    var entry = await JournalService.GetEntryWithDetailsAsync(id);
    if (entry != null)
    {
        try
        {
            var filePath = await PdfExportService.ExportSingleEntryToPdf(entry);
            // Show success message or open file
        }
        catch (Exception ex)
        {
                Console.WriteLine($"Export failed: {ex.Message}");
        }
    }
}
}