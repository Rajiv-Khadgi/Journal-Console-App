@page "/search"
@inject JournalService JournalService

<h3>Search Journal Entries</h3>

<div class="row">
    <!-- SEARCH FILTERS COLUMN -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5>Search & Filters</h5>
            </div>
            <div class="card-body">
                <!-- SEARCH TERM -->
                <div class="mb-3">
                    <label class="form-label">Search Text</label>
                    <input type="text" class="form-control"
                           placeholder="Search in title or content..."
                           @bind="searchTerm"
                           @bind:event="oninput" />
                </div>

                <!-- DATE RANGE -->
                <div class="mb-3">
                    <label class="form-label">Date Range</label>
                    <div class="row">
                        <div class="col">
                            <input type="date" class="form-control"
                                   @bind="startDate"
                                   @bind:format="yyyy-MM-dd" />
                            <small class="form-text text-muted">From</small>
                        </div>
                        <div class="col">
                            <input type="date" class="form-control"
                                   @bind="endDate"
                                   @bind:format="yyyy-MM-dd" />
                            <small class="form-text text-muted">To</small>
                        </div>
                    </div>
                </div>

                <!-- PRIMARY MOOD FILTER -->
                <div class="mb-3">
                    <label class="form-label">Primary Mood</label>
                    <select class="form-select" @bind="selectedPrimaryMood">
                        <option value="">All Moods</option>
                        @foreach (var mood in allPrimaryMoods)
                        {
                            <option value="@mood">@mood</option>
                        }
                    </select>
                </div>

                <!-- TAGS FILTER -->
                <div class="mb-3">
                    <label class="form-label">Tags</label>
                    <div style="max-height: 200px; overflow-y: auto; border: 1px solid #dee2e6; padding: 10px; border-radius: 4px;">
                        @foreach (var tag in allTags)
                        {
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox"
                                       id="tag_@tag"
                                       checked="@selectedTags.Contains(tag)"
                                       @onchange="@((e) => OnTagFilterChanged(e, tag))" />
                                <label class="form-check-label" for="tag_@tag">
                                    @tag
                                </label>
                            </div>
                        }
                    </div>
                </div>

                <!-- ACTION BUTTONS -->
                <div class="d-grid gap-2">
                    <button class="btn btn-primary" @onclick="SearchEntries">
                        <i class="bi bi-search"></i> Search
                    </button>
                    <button class="btn btn-outline-secondary" @onclick="ClearFilters">
                        <i class="bi bi-x-circle"></i> Clear Filters
                    </button>
                </div>
            </div>
        </div>

        <!-- SEARCH STATS -->
        @if (searchResults != null)
        {
            <div class="card mt-3">
                <div class="card-body">
                    <h6>Search Results</h6>
                    <p class="mb-1">Found: <strong>@searchResults.Count</strong> entries</p>
                    <p class="mb-0">Total entries: <strong>@totalEntries</strong></p>
                </div>
            </div>
        }
    </div>

    <!-- RESULTS COLUMN -->
    <div class="col-md-8">
        @if (isSearching)
        {
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Searching...</span>
                </div>
                <p class="mt-2">Searching entries...</p>
            </div>
        }
        else if (searchResults == null)
        {
            <div class="alert alert-info">
                <h5>Welcome to Search</h5>
                <p>Enter search terms and apply filters to find your journal entries.</p>
                <p>You can search by text, date range, mood, or tags.</p>
            </div>
        }
        else if (!searchResults.Any())
        {
            <div class="alert alert-warning">
                <h5>No Results Found</h5>
                <p>Try changing your search criteria or clearing filters.</p>
            </div>
        }
        else
        {
            <div class="list-group">
                @foreach (var entry in searchResults)
                {
                    <div class="list-group-item">
                        <div class="d-flex w-100 justify-content-between">
                            <h5 class="mb-1">@entry.Title</h5>
                            <small>@entry.EntryDate.ToString("MMM d, yyyy")</small>
                        </div>
                        <p class="mb-1">@GetContentPreview(entry.Content)</p>
                        <div class="mt-2">
                            <span class="badge bg-primary me-1">@entry.PrimaryMood</span>
                            @foreach (var mood in entry.SecondaryMoods.Take(2))
                            {
                                <span class="badge bg-info me-1">@mood.MoodName</span>
                            }
                            @foreach (var tag in entry.Tags.Take(3))
                            {
                                <span class="badge bg-secondary me-1">@tag.TagName</span>
                            }
                            @if (entry.Tags.Count > 3)
                            {
                                <span class="badge bg-light text-dark">+@(entry.Tags.Count - 3) more</span>
                            }
                        </div>
                        <div class="mt-2">
                            <a href="/edit/@entry.Id" class="btn btn-sm btn-primary">Edit</a>
                            <a href="/view/@entry.Id" class="btn btn-sm btn-secondary">View</a>
                        </div>
                    </div>
                }
            </div>

            <!-- PAGINATION (if many results) -->
            @if (searchResults.Count > 10)
            {
                <nav aria-label="Search results navigation" class="mt-3">
                    <ul class="pagination justify-content-center">
                        <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                            <button class="page-link" @onclick="() => ChangePage(-1)">Previous</button>
                        </li>
                        <li class="page-item active">
                            <span class="page-link">Page @currentPage of @totalPages</span>
                        </li>
                        <li class="page-item @(currentPage >= totalPages ? "disabled" : "")">
                            <button class="page-link" @onclick="() => ChangePage(1)">Next</button>
                        </li>
                    </ul>
                </nav>
            }
        }
    </div>
</div>

@code {
    // Search parameters
    private string searchTerm = "";
    private DateTime? startDate;
    private DateTime? endDate;
    private string selectedPrimaryMood = "";
    private List<string> selectedTags = new();

    // Search results
    private List<JournalEntry>? searchResults;
    private List<JournalEntry>? allEntries;
    private bool isSearching = false;
    private int totalEntries = 0;

    // Pagination
    private int currentPage = 1;
    private int pageSize = 10;
    private int totalPages = 1;

    // Available filters
    private List<string> allPrimaryMoods = new()
    {
        "Happy", "Sad", "Angry", "Relaxed", "Anxious"
    };

    private List<string> allTags = new()
    {
        "Work", "Health", "Study", "Travel", "Family",
        "Friends", "Exercise", "Reading", "Music", "Nature"
    };

    protected override async Task OnInitializedAsync()
    {
        // Load all entries for filtering
        allEntries = await JournalService.GetAllEntriesWithDetailsAsync();
        totalEntries = allEntries.Count;

        // Set default date range (last 30 days)
        endDate = DateTime.Today;
        startDate = DateTime.Today.AddDays(-30);
    }

    private async Task SearchEntries()
    {
        isSearching = true;
        StateHasChanged();

        await Task.Delay(10); // Small delay for UI responsiveness

        try
        {
            if (allEntries == null) return;

            var results = allEntries.AsEnumerable();

            // Apply text search
            if (!string.IsNullOrWhiteSpace(searchTerm))
            {
                var term = searchTerm.ToLower();
                results = results.Where(e =>
                    e.Title.ToLower().Contains(term) ||
                    e.Content.ToLower().Contains(term));
            }

            // Apply date range filter
            if (startDate.HasValue)
            {
                results = results.Where(e => e.EntryDate >= startDate.Value);
            }
            if (endDate.HasValue)
            {
                results = results.Where(e => e.EntryDate <= endDate.Value);
            }

            // Apply primary mood filter
            if (!string.IsNullOrEmpty(selectedPrimaryMood))
            {
                results = results.Where(e => e.PrimaryMood == selectedPrimaryMood);
            }

            // Apply tags filter
            if (selectedTags.Any())
            {
                results = results.Where(e =>
                    e.Tags.Any(t => selectedTags.Contains(t.TagName)));
            }

            searchResults = results.ToList();
            currentPage = 1;
            UpdatePagination();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Search error: {ex.Message}");
        }
        finally
        {
            isSearching = false;
            StateHasChanged();
        }
    }

    private void ClearFilters()
    {
        searchTerm = "";
        startDate = DateTime.Today.AddDays(-30);
        endDate = DateTime.Today;
        selectedPrimaryMood = "";
        selectedTags.Clear();
        searchResults = null;
        currentPage = 1;
        StateHasChanged();
    }

    private void OnTagFilterChanged(ChangeEventArgs e, string tag)
    {
        bool isChecked = e.Value is bool b && b;

        if (isChecked && !selectedTags.Contains(tag))
        {
            selectedTags.Add(tag);
        }
        else if (!isChecked)
        {
            selectedTags.Remove(tag);
        }
    }

    private void UpdatePagination()
    {
        if (searchResults == null) return;

        totalPages = (int)Math.Ceiling(searchResults.Count / (double)pageSize);
        if (totalPages < 1) totalPages = 1;

        if (currentPage > totalPages)
        {
            currentPage = totalPages;
        }
    }

    private List<JournalEntry> GetPaginatedResults()
    {
        if (searchResults == null) return new List<JournalEntry>();

        return searchResults
            .Skip((currentPage - 1) * pageSize)
            .Take(pageSize)
            .ToList();
    }

    private void ChangePage(int direction)
    {
        var newPage = currentPage + direction;

        if (newPage >= 1 && newPage <= totalPages)
        {
            currentPage = newPage;
        }
    }

    private string GetContentPreview(string content)
    {
        if (string.IsNullOrEmpty(content)) return "No content";

        // Strip HTML tags
        var plainText = System.Text.RegularExpressions.Regex.Replace(content, "<.*?>", string.Empty);

        // Limit length
        if (plainText.Length > 150)
        {
            return plainText.Substring(0, 150) + "...";
        }

        return plainText;
    }
}